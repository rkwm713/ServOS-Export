<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Export Cards Data</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Load Trello Power-Up library -->
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <!-- Load XLSX library for Excel/CSV export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #f4f5f7;
    }
    
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #172b4d;
      margin-bottom: 20px;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    button {
      background-color: #0079BF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: #026AA7;
    }

    button:disabled {
      background-color: #97a0af;
      cursor: not-allowed;
    }
    
    .loading {
      display: none;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0079BF;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      color: #eb5a46;
      padding: 10px;
      background: #ffebe6;
      border-radius: 3px;
      margin: 10px 0;
      display: none;
    }

    #downloadContainer {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Export Cards</h1>
    <div class="error-message" id="errorMessage"></div>
    <div class="button-group">
      <button id="exportExcel">Export to Excel</button>
      <button id="exportCSV">Export to CSV</button>
    </div>
    <div class="loading" id="loading">
      <span>Exporting...</span>
      <div class="spinner"></div>
    </div>
    <div id="downloadContainer"></div>
  </div>

  <script>
    // Initialize the Trello Power-Up iframe communication
    var t = TrelloPowerUp.iframe();

    // Utility function: show error message in the UI
    const showError = (message) => {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    };

    // Utility function: show/hide the loading indicator
    const showLoading = (isVisible) => {
      document.getElementById('loading').style.display = isVisible ? 'flex' : 'none';
    };

    /**
     * Fetches cards along with additional board data (members, lists, custom fields)
     * and maps each card into an object with keys:
     *  - cardname
     *  - cardlistname
     *  - cardlabelnames
     *  - cardmemberfullnames
     *  - plus each custom field (using the custom field's name)
     */
    async function getCardData() {
      try {
        // Fetch all cards, board members, lists, and custom field definitions in parallel
        const [cards, members, lists, customFields] = await Promise.all([
          t.cards('all'),
          t.board('members'),
          t.board('lists'),
          t.board('customFields')
        ]);

        // Build mapping from member IDs to full names
        const memberMapping = {};
        members.forEach(member => {
          memberMapping[member.id] = member.fullName || member.username;
        });

        // Build mapping from list IDs to list names
        const listMapping = {};
        lists.forEach(list => {
          listMapping[list.id] = list.name;
        });

        // Build mapping from custom field IDs to custom field names
        const customFieldMapping = {};
        if (Array.isArray(customFields)) {
          customFields.forEach(cf => {
            customFieldMapping[cf.id] = cf.name;
          });
        } else {
          for (let key in customFields) {
            customFieldMapping[customFields[key].id] = customFields[key].name;
          }
        }

        // Process each card to build the export object
        return cards.map(card => {
          // Extract custom field values from the card (if any)
          let cardCustomFields = {};
          if (card.customFieldItems) {
            card.customFieldItems.forEach(item => {
              // Determine the display name of the custom field using our mapping
              const fieldName = customFieldMapping[item.idCustomField] || item.idCustomField;
              let value = '';
              if (item.value) {
                if (item.value.text) {
                  value = item.value.text;
                } else if (item.value.number) {
                  value = item.value.number;
                } else if (item.value.date) {
                  value = new Date(item.value.date).toLocaleString();
                }
              }
              cardCustomFields[fieldName] = value;
            });
          }
          return {
            cardname: card.name,
            cardlistname: listMapping[card.idList] || '',
            cardlabelnames: card.labels ? card.labels.map(l => l.name).join(', ') : '',
            cardmemberfullnames: card.idMembers ? card.idMembers.map(id => memberMapping[id]).join(', ') : '',
            ...cardCustomFields
          };
        });
      } catch (error) {
        throw new Error('Failed to fetch card data: ' + error.message);
      }
    }

    /**
     * Helper: Given an array of card objects, determine the header order.
     * We want the headers in the order:
     *  [cardname, cardlistname, cardlabelnames, cardmemberfullnames, ...custom fields]
     */
    function determineHeaderOrder(cards) {
      const fixedHeaders = ['cardname', 'cardlistname', 'cardlabelnames', 'cardmemberfullnames'];
      const extraHeadersSet = new Set();
      cards.forEach(card => {
        Object.keys(card).forEach(key => {
          if (!fixedHeaders.includes(key)) {
            extraHeadersSet.add(key);
          }
        });
      });
      const extraHeaders = Array.from(extraHeadersSet);
      return fixedHeaders.concat(extraHeaders);
    }

    // Export card data to an Excel file
    async function exportToExcel() {
      try {
        showLoading(true);
        const cards = await getCardData();
        const headerOrder = determineHeaderOrder(cards);
        const workbook = XLSX.utils.book_new();
        // Create a worksheet using the header order; this ensures our CSV/Excel shows the desired headers.
        const worksheet = XLSX.utils.json_to_sheet(cards, { header: headerOrder });
        XLSX.utils.book_append_sheet(workbook, worksheet, "Cards");
        XLSX.writeFile(workbook, "trello-cards.xlsx");
        showLoading(false);
      } catch (error) {
        showLoading(false);
        showError(error.message);
      }
    }

    // Export card data to a CSV file
    async function exportToCSV() {
      try {
        showLoading(true);
        const cards = await getCardData();
        const headerOrder = determineHeaderOrder(cards);
        // Create a worksheet with the desired headers
        const worksheet = XLSX.utils.json_to_sheet(cards, { header: headerOrder });
        // Convert the worksheet to CSV text
        const csv = XLSX.utils.sheet_to_csv(worksheet);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'trello-cards.csv';
        link.click();
        showLoading(false);
      } catch (error) {
        showLoading(false);
        showError(error.message);
      }
    }

    // Attach event listeners to the export buttons
    document.getElementById('exportExcel').addEventListener('click', exportToExcel);
    document.getElementById('exportCSV').addEventListener('click', exportToCSV);
  </script>
</body>
</html>
