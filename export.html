<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Export Cards Data - Debug Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Load Trello Power-Up library -->
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <!-- Load XLSX library for Excel/CSV export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #f4f5f7;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    h1 {
      color: #172b4d;
      margin-bottom: 20px;
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    button {
      background-color: #0079BF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #026AA7;
    }
    button:disabled {
      background-color: #97a0af;
      cursor: not-allowed;
    }
    .loading {
      display: none;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0079BF;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-message {
      color: #eb5a46;
      padding: 10px;
      background: #ffebe6;
      border-radius: 3px;
      margin: 10px 0;
      display: none;
    }
    #downloadContainer {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Export Cards (Debug Mode)</h1>
    <div class="error-message" id="errorMessage"></div>
    <div class="button-group">
      <button id="exportExcel">Export to Excel</button>
      <button id="exportCSV">Export to CSV</button>
    </div>
    <div class="loading" id="loading">
      <span>Exporting...</span>
      <div class="spinner"></div>
    </div>
    <div id="downloadContainer"></div>
  </div>

  <script>
    // Initialize Trello Power-Up communication
    var t = TrelloPowerUp.iframe();

    // Utility: Display error messages in the UI
    const showError = (message) => {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    };

    // Utility: Show or hide the loading indicator
    const showLoading = (isVisible) => {
      document.getElementById('loading').style.display = isVisible ? 'flex' : 'none';
    };

    /**
     * Fetch board data separately so we can pinpoint which command fails.
     * Each call is wrapped in its own try–catch block and logs to the console.
     */
    async function getBoardData() {
      let cards = [], members = [], lists = [], customFields = [];
      
      try {
        cards = await t.cards('all');
        console.log('Cards fetched:', cards);
      } catch (error) {
        console.error("Failed to fetch cards (t.cards('all')):", error);
      }
      
      try {
        let membersResult = await t.board('members');
        console.log('Raw members result:', membersResult);
        if (Array.isArray(membersResult)) {
          members = membersResult;
        } else if (membersResult && typeof membersResult === 'object') {
          members = Object.values(membersResult);
        } else {
          members = [];
        }
        console.log('Members fetched:', members);
      } catch (error) {
        console.error("Failed to fetch board('members'):", error);
        members = [];
      }
      
      try {
        let listsResult = await t.board('lists');
        console.log('Raw lists result:', listsResult);
        if (Array.isArray(listsResult)) {
          lists = listsResult;
        } else if (listsResult && typeof listsResult === 'object') {
          lists = Object.values(listsResult);
        } else {
          lists = [];
        }
        console.log('Lists fetched:', lists);
      } catch (error) {
        console.error("Failed to fetch board('lists'):", error);
        lists = [];
      }
      
      try {
        let customFieldsResult = await t.board('customFields');
        console.log('Raw custom fields result:', customFieldsResult);
        if (Array.isArray(customFieldsResult)) {
          customFields = customFieldsResult;
        } else if (customFieldsResult && typeof customFieldsResult === 'object') {
          customFields = Object.values(customFieldsResult);
        } else {
          customFields = [];
        }
        console.log('Custom fields fetched:', customFields);
      } catch (error) {
        console.warn("Failed to fetch board('customFields'):", error);
        customFields = [];
      }
      
      return { cards, members, lists, customFields };
    }

    /**
     * Process the fetched data and map each card into an object with:
     * - cardname
     * - cardlistname
     * - cardlabelnames
     * - cardmemberfullnames
     * - plus any custom fields (using the custom field's name)
     */
    async function getCardData() {
      try {
        const { cards, members, lists, customFields } = await getBoardData();

        // Build mapping: member ID → full name
        const memberMapping = {};
        if (Array.isArray(members)) {
          members.forEach(member => {
            memberMapping[member.id] = member.fullName || member.username || "";
          });
        } else {
          console.warn("Members is not an array, received:", members);
        }

        // Build mapping: list ID → list name
        const listMapping = {};
        if (Array.isArray(lists)) {
          lists.forEach(list => {
            listMapping[list.id] = list.name;
          });
        } else {
          console.warn("Lists is not an array, received:", lists);
        }

        // Build mapping: custom field ID → custom field name
        // NOTE: Many custom field objects may use "idCustomField" rather than "id"
        const customFieldMapping = {};
        if (Array.isArray(customFields)) {
          customFields.forEach(cf => {
            const cfId = cf.idCustomField || cf.id;  // Use idCustomField if available
            customFieldMapping[cfId] = cf.name;
          });
        } else {
          console.warn("Custom fields is not an array, received:", customFields);
        }

        // Map each card into the desired export object
        return cards.map(card => {
          let cardCustomFields = {};
          if (card.customFieldItems) {
            card.customFieldItems.forEach(item => {
              // Look up the custom field name using idCustomField from the card data
              const fieldName = customFieldMapping[item.idCustomField] || item.idCustomField;
              let value = '';
              if (item.value) {
                if (item.value.text) {
                  value = item.value.text;
                } else if (item.value.number) {
                  value = item.value.number;
                } else if (item.value.date) {
                  value = new Date(item.value.date).toLocaleString();
                }
              }
              cardCustomFields[fieldName] = value;
            });
          }
          return {
            cardname: card.name,
            cardlistname: listMapping[card.idList] || '',
            cardlabelnames: card.labels ? card.labels.map(l => l.name).join(', ') : '',
            cardmemberfullnames: card.idMembers ? card.idMembers.map(id => memberMapping[id]).join(', ') : '',
            ...cardCustomFields
          };
        });
      } catch (error) {
        throw new Error('Failed to fe
