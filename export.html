<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Export Cards Data</title>
    <!-- Include the Trello Power-Up client library -->
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
      body { font-family: sans-serif; margin: 20px; }
      #status { margin-top: 20px; }
      button { font-size: 1em; padding: 10px 15px; }
      #authSection, #exportSection { margin-bottom: 20px; }
    </style>
  </head>
  <body>
    <h2>Export Cards Data</h2>
    <div id="authSection" style="display:none;">
      <p>Please authorize this Power-Up to access your board data.</p>
      <button id="authBtn">Login with Trello</button>
    </div>
    <div id="exportSection" style="display:none;">
      <button id="exportBtn">Export Now</button>
      <div id="status"></div>
    </div>

    <script>
      (function() {
        var apiKey = 'b3fe974eb0a783caa600c2f8c3d08c95'; // Your Trello API key
        var netlifyBaseUrl = 'https://servoscsvexport.netlify.app/.netlify/functions'; // Change if needed
        var t = TrelloPowerUp.iframe();

        async function getToken(userId) {
          return localStorage.getItem(`trello_token_${userId}`);
        }

        /**
         * Initiates the OAuth process by redirecting the user to Trelloâ€™s authorization page.
         */
        function initiateOAuth(userId) {
          var returnUrl = encodeURIComponent(window.location.href);
          var authUrl = `https://trello.com/1/authorize?expiration=never&name=Export%20Cards%20Power-Up&scope=read&response_type=token&key=${apiKey}&return_url=${returnUrl}`;

          window.location.href = authUrl;
        }

        /**
         * Save the token on the server via Netlify function.
         */
        async function saveToken(userId, token) {
          localStorage.setItem(`trello_token_${userId}`, token);
        }
        /**
         * Initialize the process to get or generate a token.
         */
        async function initialize() {
          const context = await t.getContext();
          const userId = context.member;

          // Check for token on the server
          let token = await getToken(userId);
          
          if (!token && window.location.hash) {
            // Handle redirect after OAuth and extract the token
            var hash = window.location.hash.substring(1); 
            var params = new URLSearchParams(hash);
            token = params.get('token');

            if (token) {
              // Save token to server
              await saveToken(userId, token);
              window.location.hash = ''; // Clean up URL
              document.getElementById('exportSection').style.display = 'block';
              return;
            }
          }

          if (token) {
            document.getElementById('exportSection').style.display = 'block';
            setupExportButton(token);
          } else {
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('authBtn').addEventListener('click', function() {
              initiateOAuth(userId);
            });
          }
        }

        /**
         * Set up the export functionality once a token is available.
         */
        function setupExportButton(token) {
          document.getElementById('exportBtn').addEventListener('click', async function() {
            this.disabled = true;
            document.getElementById('status').innerText = 'Exporting...';

            const context = await t.getContext();
            const boardId = context.board;

            // Build API URLs
            const listsURL = `https://api.trello.com/1/boards/${boardId}/lists?fields=name,id&key=${apiKey}&token=${token}`;
            const cardsURL = `https://api.trello.com/1/boards/${boardId}/cards?fields=name,idList,labels,idMembers,customFieldItems&customFieldItems=true&key=${apiKey}&token=${token}`;
            
            // Fetch data and export as CSV
            try {
              const [lists, cards] = await Promise.all([
                fetch(listsURL).then(res => res.json()),
                fetch(cardsURL).then(res => res.json())
              ]);

              const csvContent = generateCSV(lists, cards);
              downloadCSV(csvContent, 'trello_cards_export.csv');
            } catch (err) {
              console.error('Error fetching data:', err);
              document.getElementById('status').innerText = 'Error: ' + err.message;
            }
          });
        }

        /**
         * Generate CSV content from lists and cards.
         */
        function generateCSV(lists, cards) {
          const listMap = {};
          lists.forEach(list => { listMap[list.id] = list.name; });

          const csvRows = [['Card Name', 'List Name', 'Labels']];
          cards.forEach(card => {
            const row = [
              `"${(card.name || '').replace(/"/g, '""')}"`,
              `"${(listMap[card.idList] || '').replace(/"/g, '""')}"`,
              `"${(card.labels || []).map(label => label.name).join('; ').replace(/"/g, '""')}"`
            ];
            csvRows.push(row.join(','));
          });

          return csvRows.join('\n');
        }

        /**
         * Download the generated CSV file.
         */
        function downloadCSV(content, filename) {
          const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = filename;
          document.getElementById('status').innerHTML = '';
          a.click();
        }

        // Start initialization
        initialize();
      })();
    </script>
  </body>
</html>
