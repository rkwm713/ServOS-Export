<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Export Cards Data - Debug Mode</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Load Trello Power-Up library -->
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <!-- Load XLSX library for Excel/CSV export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
        background-color: #f4f5f7;
      }
      .container {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #172b4d;
        margin-bottom: 20px;
      }
      .button-group {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
      }
      button {
        background-color: #0079BF;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 3px;
        cursor: pointer;
        font-size: 14px;
        transition: background-color 0.2s;
      }
      button:hover {
        background-color: #026AA7;
      }
      button:disabled {
        background-color: #97a0af;
        cursor: not-allowed;
      }
      .loading {
        display: none;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
      }
      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0079BF;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      .error-message {
        color: #eb5a46;
        padding: 10px;
        background: #ffebe6;
        border-radius: 3px;
        margin: 10px 0;
        display: none;
      }
      #downloadContainer {
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Export Cards (Debug Mode)</h1>
      <div class="error-message" id="errorMessage"></div>
      <div class="button-group">
        <button id="exportExcel">Export to Excel</button>
        <button id="exportCSV">Export to CSV</button>
      </div>
      <div class="loading" id="loading">
        <span>Exporting...</span>
        <div class="spinner"></div>
      </div>
      <div id="downloadContainer"></div>
    </div>

    <script>
      // Initialize Trello Power-Up for popup pages.
      var t = TrelloPowerUp.iframe();

      // Utility: Display error messages in the UI.
      const showError = (message) => {
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
      };

      // Utility: Show or hide the loading indicator.
      const showLoading = (isVisible) => {
        document.getElementById('loading').style.display = isVisible ? 'flex' : 'none';
      };

      /**
       * Fetch board data (cards, members, lists, custom fields) separately.
       * Each call is wrapped in its own tryâ€“catch block.
       */
      async function getBoardData() {
        let cards = [], members = [], lists = [], customFields = [];
        
        // Fetch cards
        try {
          cards = await t.cards('all');
          console.log('Cards fetched:', cards);
        } catch (error) {
          console.error("Failed to fetch cards (t.cards('all')):", error);
        }
        
        // Fetch members and ensure we have an array
        try {
          let membersResult = await t.board('members');
          console.log('Raw members result:', membersResult);
          if (Array.isArray(membersResult)) {
            members = membersResult;
          } else if (membersResult && typeof membersResult === 'object') {
            members = Object.values(membersResult);
          } else {
            members = [];
          }
          console.log('Members fetched:', members);
        } catch (error) {
          console.error("Failed to fetch board('members'):", error);
          members = [];
        }
        
        // Fetch lists and ensure we have an array; if this fails, log error and default to []
        try {
          let listsResult = await t.board('lists');
          console.log('Raw lists result:', listsResult);
          if (Array.isArray(listsResult)) {
            lists = listsResult;
          } else if (listsResult && typeof listsResult === 'object') {
            lists = Object.values(listsResult);
          } else {
            lists = [];
          }
          console.log('Lists fetched:', lists);
        } catch (error) {
          console.error("Failed to fetch board('lists'):", error, JSON.stringify(error));
          lists = [];
        }
        
        // Fetch custom fields and ensure we have an array.
        try {
          let customFieldsResult = await t.board('customFields');
          console.log('Raw custom fields result:', customFieldsResult);
          if (Array.isArray(customFieldsResult)) {
            customFields = customFieldsResult;
          } else if (customFieldsResult && typeof customFieldsResult === 'object') {
            customFields = Object.values(customFieldsResult);
          } else {
            customFields = [];
          }
          console.log('Custom fields fetched:', customFields);
        } catch (error) {
          console.warn("Failed to fetch board('customFields'):", error);
          customFields = [];
        }
        
        return { cards, members, lists, customFields };
      }

      /**
       * Process the fetched data and build an export object for each card.
       * The export object contains fixed fields:
       *   "Card Name", "List Name", "Labels", "Members"
       * and custom fields in a fixed order.
       */
      async function getCardData() {
        try {
          const { cards, members, lists, customFields } = await getBoardData();

          // Fixed header mappings.
          const fixedHeaders = {
            "Card Name": card => card.name,
            "List Name": card => lists.find(l => l.id === card.idList)?.name || "",
            "Labels": card => card.labels ? card.labels.map(l => l.name).join(', ') : "",
            "Members": card => card.idMembers ? card.idMembers.map(id => {
              const member = members.find(m => m.id === id);
              return member ? (member.fullName || member.username) : "";
            }).join(', ') : ""
          };

          // Define desired custom fields (in the order you want)
          const desiredCustomFields = [
            "W.O. #",
            "Attacher W.O. #",
            "Katapult",
            "Staking Site Count",
            "TT Site Count",
            "TT Start",
            "Sent to Landon",
            "TT Received Back",
            "ArcFM Start",
            "ArcFM Finished",
            "Sent to Damon",
            "Sent to Scheduling",
            "Added to Schedule",
            "Construction Started",
            "Construction Completed",
            "Pre-ArcFM Started",
            "Pre-ArcFM Completed",
            "Priority",
            "OneDrive Link"
          ];

          // Build a mapping from custom field name to its ID
          const customFieldNameToId = {};
          if (Array.isArray(customFields)) {
            customFields.forEach(cf => {
              // Many custom field definitions use "idCustomField" instead of "id"
              const cfId = cf.idCustomField || cf.id;
              if (cf.name) {
                customFieldNameToId[cf.name] = cfId;
              }
            });
          }

          // For each card, build the export object.
          // Start with fixed columns, then add each desired custom field.
          return cards.map(card => {
            let exportObject = {};

            // Fixed fields:
            Object.keys(fixedHeaders).forEach(key => {
              exportObject[key] = fixedHeaders[key](card);
            });

            // Custom fields: loop over desiredCustomFields and get the value
            // from card.customFieldItems (if exists) that matches the ID in our mapping.
            desiredCustomFields.forEach(fieldName => {
              let value = "";
              const cfId = customFieldNameToId[fieldName];
              if (cfId && card.customFieldItems) {
                const cfItem = card.customFieldItems.find(item => item.idCustomField === cfId);
                if (cfItem && cfItem.value) {
                  if (cfItem.value.text) {
                    value = cfItem.value.text;
                  } else if (cfItem.value.number) {
                    value = cfItem.value.number;
                  } else if (cfItem.value.date) {
                    value = new Date(cfItem.value.date).toLocaleString();
                  }
                }
              }
              exportObject[fieldName] = value;
            });

            return exportObject;
          });
        } catch (error) {
          throw new Error('Failed to fetch card data: ' + error.message);
        }
      }

      /**
       * Determine header order for export.
       * Fixed headers (in order) followed by desired custom fields (in order).
       */
      function determineHeaderOrder() {
        const fixedHeaders = ["Card Name", "List Name", "Labels", "Members"];
        const desiredCustomFields = [
          "W.O. #",
          "Attacher W.O. #",
          "Katapult",
          "Staking Site Count",
          "TT Site Count",
          "TT Start",
          "Sent to Landon",
          "TT Received Back",
          "ArcFM Start",
          "ArcFM Finished",
          "Sent to Damon",
          "Sent to Scheduling",
          "Added to Schedule",
          "Construction Started",
          "Construction Completed",
          "Pre-ArcFM Started",
          "Pre-ArcFM Completed",
          "Priority",
          "OneDrive Link"
        ];
        return fixedHeaders.concat(desiredCustomFields);
      }

      // Export card data to an Excel file
      async function exportToExcel() {
        try {
          showLoading(true);
          const cards = await getCardData();
          const headerOrder = determineHeaderOrder();
          const workbook = XLSX.utils.book_new();
          const worksheet = XLSX.utils.json_to_sheet(cards, { header: headerOrder });
          XLSX.utils.book_append_sheet(workbook, worksheet, "Cards");
          XLSX.writeFile(workbook, "trello-cards.xlsx");
          showLoading(false);
        } catch (error) {
          showLoading(false);
          showError(error.message);
        }
      }

      // Export card data to a CSV file
      async function exportToCSV() {
        try {
          showLoading(true);
          const cards = await getCardData();
          const headerOrder = determineHeaderOrder();
          const worksheet = XLSX.utils.json_to_sheet(cards, { header: headerOrder });
          const csv = XLSX.utils.sheet_to_csv(worksheet);
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = 'trello-cards.csv';
          link.click();
          showLoading(false);
        } catch (error) {
          showLoading(false);
          showError(error.message);
        }
      }

      // Attach event listeners to the export buttons
      document.getElementById('exportExcel').addEventListener('click', exportToExcel);
      document.getElementById('exportCSV').addEventListener('click', exportToCSV);
    </script>
  </body>
</html>
