<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Export Cards Data</title>

  <script>
    (function () {
      var t = TrelloPowerUp.iframe();

      async function getToken(userId) {
        return localStorage.getItem(`trello_token_${userId}`);
      }

      async function saveToken(userId, token) {
        localStorage.setItem(`trello_token_${userId}`, token);
      }

      /**
       * Fetch board data directly from Trelloâ€™s API
       */
      async function getBoardData(boardId, token) {
        const apiKey = 'b3fe974eb0a783caa600c2f8c3d08c95';
        const listsURL = `https://api.trello.com/1/boards/${boardId}/lists?fields=name,id&key=${apiKey}&token=${token}`;
        const cardsURL = `https://api.trello.com/1/boards/${boardId}/cards?fields=name,idList,labels,idMembers&key=${apiKey}&token=${token}`;

        const [lists, cards] = await Promise.all([
          fetch(listsURL).then(res => res.json()),
          fetch(cardsURL).then(res => res.json())
        ]);

        return { lists, cards };
      }

      async function initialize() {
        const context = await t.getContext();
        const userId = context.member;

        // Check for token in local storage
        let token = await getToken(userId);

        if (!token && window.location.hash) {
          // Handle redirect after OAuth and extract the token
          var hash = window.location.hash.substring(1);
          var params = new URLSearchParams(hash);
          token = params.get('token');

          if (token) {
            // Save token to local storage
            await saveToken(userId, token);
            window.location.hash = ''; // Clean up URL
            document.getElementById('exportSection').style.display = 'block';
            return;
          }
        }

        if (token) {
          document.getElementById('exportSection').style.display = 'block';
          setupExportButton(token);
        } else {
          document.getElementById('authSection').style.display = 'block';
          document.getElementById('authBtn').addEventListener('click', function () {
            initiateOAuth(userId);
          });
        }
      }

      function initiateOAuth(userId) {
        const returnUrl = window.location.href;
        const scope = 'read';
        const expiration = '1hour';
        const name = 'ServOS Export';
        t.authorize({
          name: name,
          expiration: expiration,
          scope: scope,
          success: function () {
            document.getElementById('exportSection').style.display = 'block';
            document.getElementById('authSection').style.display = 'none';
          }
        });
      }

      function setupExportButton(token) {
        document.getElementById('exportBtn').addEventListener('click', async function () {
          this.disabled = true;
          document.getElementById('status').innerText = 'Exporting...';

          try {
            const context = await t.getContext();
            const boardId = context.board;

            // Get board data directly from Trello's API
            const { lists, cards } = await getBoardData(boardId, token);
            const csvContent = generateCSV(lists, cards);
            downloadCSV(csvContent, 'trello_cards_export.csv');
          } catch (err) {
            console.error('Error fetching data:', err);
            document.getElementById('status').innerText = 'Error: ' + err.message;
          }
        });
      }

      function generateCSV(lists, cards) {
        const listMap = {};
        lists.forEach(list => { listMap[list.id] = list.name; });

        const csvRows = [['Card Name', 'List Name', 'Labels']];
        cards.forEach(card => {
          const row = [
            `"${(card.name || '').replace(/"/g, '""')}"`,
            `"${(listMap[card.idList] || '').replace(/"/g, '""')}"`,
            `"${(card.labels || []).map(label => label.name).join('; ').replace(/"/g, '""')}"`
          ];
          csvRows.push(row.join(','));
        });

        return csvRows.join('\n');
      }

      function downloadCSV(content, filename) {
        const blob = new Blob([content], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.getElementById('status').innerHTML = '';
        a.click();
      }

      initialize();
    })();
  </script>
</head>

<body>
  <h1>Export Cards Data</h1>
  <p>This is where you can add the content for exporting cards.</p>
</body>

</html>
