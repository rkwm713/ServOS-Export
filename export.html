<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Export Cards Data</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Load Trello Power-Up library -->
  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <!-- Load XLSX library for Excel/CSV export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      background-color: #f4f5f7;
    }
    
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #172b4d;
      margin-bottom: 20px;
    }
    
    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    button {
      background-color: #0079BF;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    
    button:hover {
      background-color: #026AA7;
    }

    button:disabled {
      background-color: #97a0af;
      cursor: not-allowed;
    }
    
    .loading {
      display: none;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #0079BF;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error-message {
      color: #eb5a46;
      padding: 10px;
      background: #ffebe6;
      border-radius: 3px;
      margin: 10px 0;
      display: none;
    }

    #downloadContainer {
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Export Cards</h1>
    <div class="error-message" id="errorMessage"></div>
    <div class="button-group">
      <button id="exportExcel">Export to Excel</button>
      <button id="exportCSV">Export to CSV</button>
    </div>
    <div class="loading" id="loading">
      <span>Exporting...</span>
      <div class="spinner"></div>
    </div>
    <div id="downloadContainer"></div>
  </div>

  <script>
    // Initialize the Trello Power-Up iframe communication
    var t = TrelloPowerUp.iframe();
    
    // Display an error message in the UI
    const showError = (message) => {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
    };

    // Toggle the loading indicator
    const showLoading = (isVisible) => {
      document.getElementById('loading').style.display = isVisible ? 'flex' : 'none';
    };

    // Fetch card data from the board with error handling
    async function getCardData() {
      try {
        const cards = await t.cards('all');
        // Process each card to extract necessary fields
        return cards.map(card => ({
          id: card.id,
          name: card.name,
          description: card.desc,
          url: card.url,
          due: card.due ? new Date(card.due).toLocaleString() : '',
          list: card.list ? card.list.name : '',
          labels: card.labels ? card.labels.map(l => l.name).join(', ') : ''
        }));
      } catch (error) {
        throw new Error('Failed to fetch card data: ' + error.message);
      }
    }

    // Export card data to an Excel file
    async function exportToExcel() {
      try {
        showLoading(true);
        const cards = await getCardData();
        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.json_to_sheet(cards);
        XLSX.utils.book_append_sheet(workbook, worksheet, "Cards");
        XLSX.writeFile(workbook, "trello-cards.xlsx");
        showLoading(false);
      } catch (error) {
        showLoading(false);
        showError(error.message);
      }
    }

    // Export card data to a CSV file
    async function exportToCSV() {
      try {
        showLoading(true);
        const cards = await getCardData();
        const worksheet = XLSX.utils.json_to_sheet(cards);
        const csv = XLSX.utils.sheet_to_csv(worksheet);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'trello-cards.csv';
        link.click();
        showLoading(false);
      } catch (error) {
        showLoading(false);
        showError(error.message);
      }
    }

    // Attach event listeners to the export buttons
    document.getElementById('exportExcel').addEventListener('click', exportToExcel);
    document.getElementById('exportCSV').addEventListener('click', exportToCSV);
  </script>
</body>
</html>

