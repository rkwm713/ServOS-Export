<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Trello Export Power-Up (Enhanced)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Load the Trello Power-Up client library -->
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
  </head>
  <body>
    <script>
      // URL for your custom icon (must be hosted via HTTPS)
      const ICON_URL = 'https://rkwm713.github.io/ServOS-Export/icon.png';

      // Check if a secret is provided (for signing external URLs)
      if (!TrelloPowerUp.iframe().arg('secret')) {
        console.warn('Power-Up iframe initialized without a secret. Signing URLs (if needed) may not work.');
      }
      
      // Define the board button capability: returns a button that opens the export popup
      const boardButtonsCapability = (t, options) => {
        return [{
          icon: {
            dark: ICON_URL,
            light: ICON_URL
          },
          text: 'Export Cards',
          condition: 'always',
          callback: async function(t) {
            try {
              // If you need to open an external URL, sign it with t.signUrl(...)
              // For example:
              // let signedUrl = t.signUrl('https://yourdomain.com/export.html');
              return t.popup({
                title: 'Export Cards Data',
                url: './export.html',
                height: 500,  // Adjust height as needed
                fullscreen: false
              });
            } catch (error) {
              console.error('Error in board button callback:', error);
              return { error: true, message: error.message || 'An error occurred' };
            }
          }
        }];
      };

      // Initialize the Power-Up on the connector page.
      TrelloPowerUp.initialize({
        'board-buttons': boardButtonsCapability,
        'authorization-status': async (t, options) => {
          const authStatus = await t.get('member', 'private', 'authStatus');
          return { authorized: !!authStatus };
        },
        'show-settings': async (t, options) => {
          try {
            return t.popup({
              title: 'Export Settings',
              url: './settings.html',
              height: 200
            });
          } catch (error) {
            console.error('Error showing settings:', error);
            return { error: true, message: error.message };
          }
        }
      }, {
        appName: 'ServOS Export',
        apiVersion: 1,
        enableContext: true
      });
    </script>
  </body>
</html>
